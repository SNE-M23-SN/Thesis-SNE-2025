<!DOCTYPE HTML>
<html lang="ru">
<head>
<!-- Generated by javadoc (21) on Fri Jun 06 16:44:09 SAMT 2025 -->
<title>SimpleDbChatMemory</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="dc.created" content="2025-06-06">
<meta name="description" content="declaration: package: com.diploma.inno.component, class: SimpleDbChatMemory">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../script-dir/jquery-ui.min.css" title="Style">
<script type="text/javascript" src="../../../../script.js"></script>
<script type="text/javascript" src="../../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var pathtoroot = "../../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top"><button id="navbar-toggle-button" aria-controls="navbar-top" aria-expanded="false" aria-label="Toggle navigation links"><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span></button>
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../../index.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/SimpleDbChatMemory.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../index-files/index-1.html">Index</a></li>
<li><a href="../../../../help-doc.html#class">Help</a></li>
</ul>
<ul class="sub-nav-list-small">
<li>
<p>Summary:</p>
<ul>
<li>Nested</li>
<li>Field</li>
<li><a href="#constructor-summary">Constr</a></li>
<li><a href="#method-summary">Method</a></li>
</ul>
</li>
<li>
<p>Detail:</p>
<ul>
<li>Field</li>
<li><a href="#constructor-detail">Constr</a></li>
<li><a href="#method-detail">Method</a></li>
</ul>
</li>
</ul>
</div>
<div class="sub-nav">
<div id="navbar-sub-list">
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li>Nested&nbsp;|&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#constructor-summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-summary">Method</a></li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#constructor-detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-detail">Method</a></li>
</ul>
</div>
<div class="nav-list-search"><a href="../../../../search.html">SEARCH</a>
<input type="text" id="search-input" disabled placeholder="Search">
<input type="reset" id="reset-button" disabled value="reset">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">com.diploma.inno.component</a></div>
<h1 title="Class SimpleDbChatMemory" class="title">Class SimpleDbChatMemory</h1>
</div>
<div class="inheritance" title="Inheritance Tree"><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">java.lang.Object</a>
<div class="inheritance">com.diploma.inno.component.SimpleDbChatMemory</div>
</div>
<section class="class-description" id="class-description">
<dl class="notes">
<dt>All Implemented Interfaces:</dt>
<dd><code>org.springframework.ai.chat.memory.ChatMemory</code></dd>
</dl>
<hr>
<div class="type-signature"><span class="modifiers">public class </span><span class="element-name type-name-label">SimpleDbChatMemory</span>
<span class="extends-implements">extends <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a>
implements org.springframework.ai.chat.memory.ChatMemory</span></div>
<div class="block">Database-backed implementation of Spring AI's ChatMemory interface for Jenkins CI/CD anomaly detection system.

 <p>This implementation provides persistent conversation memory storage using PostgreSQL database,
 specifically designed for handling high-volume Jenkins build logs with sophisticated memory management,
 automatic cleanup, and build-specific tracking capabilities.</p>

 <h2 id="core-features-heading">Core Features</h2>
 <ul>
   <li><strong>Persistent Storage:</strong> PostgreSQL-backed conversation history with JSONB support</li>
   <li><strong>Memory Management:</strong> Automatic pruning &amp; sliding window approach for scalability</li>
   <li><strong>Build Tracking:</strong> Specialized support for Jenkins build number correlation</li>
   <li><strong>Content Optimization:</strong> Intelligent truncation &amp; compression for large log messages</li>
   <li><strong>Metadata Preservation:</strong> Rich metadata support for contextual AI analysis</li>
   <li><strong>Transaction Safety:</strong> Full ACID compliance with Spring's transaction management</li>
 </ul>

 <h2 id="architecture-integration-heading">Architecture Integration</h2>
 <p>This component integrates seamlessly with the CI/CD anomaly detection pipeline:</p>
 <pre><code>
 Jenkins Logs → LogMessageListener → SimpleDbChatMemory → PostgreSQL Database
      ↓               ↓                      ↓                    ↓
 Raw Messages → Message Objects → ChatMessageEntity → Persistent Storage
      ↑               ↑                      ↑                    ↑
 AI Analysis ← CustomMemoryAdvisor ← Message Retrieval ← Query Optimization
 </code></pre>

 <h2 id="memory-management-strategy-heading">Memory Management Strategy</h2>
 <p>The implementation uses a sophisticated multi-layered approach:</p>
 <ol>
   <li><strong>Sliding Window:</strong> Maintains configurable number of recent messages per conversation</li>
   <li><strong>Scheduled Cleanup:</strong> Hourly pruning of old messages to prevent unbounded growth</li>
   <li><strong>Content Truncation:</strong> Automatic truncation of oversized messages (10MB limit)</li>
   <li><strong>Efficient Queries:</strong> Optimized database queries with proper indexing</li>
 </ol>

 <h2 id="data-model-storage-heading">Data Model &amp; Storage</h2>
 <p>Messages are stored using a rich entity model:</p>
 
<div class="snippet-container"><button class="copy snippet-copy" aria-label="Copy snippet" onclick="copySnippet(this)"><span data-copied="Copied!">Copy</span><img src="../../../../copy.svg" alt="Copy snippet"></button>
<pre class="snippet"><code class="language-json">{
  "id": 12345,
  "conversation_id": "jenkins-security-pipeline",
  "build_number": 123,
  "message_type": "USER",
  "content": "{\"type\":\"build_log_data\",\"data\":{...}}",
  "timestamp": "2024-01-15T14:30:45.123+05:00",
  "created_at": "2024-01-15T14:30:45.123+05:00",
  "job_name": "jenkins-security-pipeline",
  "metadata": {
    "build_number": 123,
    "log_type": "build_log_data"
  }
}
</code></pre>
</div>


 <h2 id="build-specific-features-heading">Build-Specific Features</h2>
 <p>Specialized functionality for Jenkins build monitoring:</p>
 <ul>
   <li><strong>Build Log Tracking:</strong> Monitors completion of build log pairs (initial + final)</li>
   <li><strong>Conversation Correlation:</strong> Links messages to specific Jenkins jobs &amp; builds</li>
   <li><strong>Metadata Enrichment:</strong> Preserves build numbers &amp; job context</li>
   <li><strong>Query Optimization:</strong> Efficient retrieval by conversation &amp; build number</li>
 </ul>

 <h2 id="performance-characteristics-heading">Performance Characteristics</h2>
 <ul>
   <li><strong>Throughput:</strong> Optimized for high-volume message ingestion (1000+ messages/minute)</li>
   <li><strong>Storage Efficiency:</strong> JSONB compression &amp; intelligent content management</li>
   <li><strong>Query Performance:</strong> Indexed queries with sub-millisecond retrieval times</li>
   <li><strong>Memory Usage:</strong> Bounded memory with automatic cleanup mechanisms</li>
 </ul>

 <h2 id="configuration-tuning-heading">Configuration &amp; Tuning</h2>
 <p>Key configuration parameters:</p>
 <ul>
   <li><strong>maxMessagesPerConversation:</strong> Sliding window size (default: 100)</li>
   <li><strong>MAX_CONTENT_LENGTH:</strong> Message size limit (10MB)</li>
   <li><strong>Cleanup Schedule:</strong> Hourly pruning with 1-hour initial delay</li>
 </ul>

 <h2 id="thread-safety-concurrency-heading">Thread Safety &amp; Concurrency</h2>
 <p>This implementation is fully thread-safe and supports concurrent operations:</p>
 <ul>
   <li><strong>Transaction Isolation:</strong> Proper isolation levels for concurrent access</li>
   <li><strong>Repository Safety:</strong> Spring Data JPA handles concurrent database operations</li>
   <li><strong>Atomic Operations:</strong> All operations are atomic within transaction boundaries</li>
 </ul>

 <h2 id="usage-examples-heading">Usage Examples</h2>
 
<div class="snippet-container"><button class="copy snippet-copy" aria-label="Copy snippet" onclick="copySnippet(this)"><span data-copied="Copied!">Copy</span><img src="../../../../copy.svg" alt="Copy snippet"></button>
<pre class="snippet"><code class="language-java">// Basic configuration
ChatMessageRepository repository = // ... injected
SimpleDbChatMemory memory = new SimpleDbChatMemory(repository, 100);

// Store Jenkins log message
UserMessage logMessage = new UserMessage(
    "{\"type\":\"build_log_data\",\"job_name\":\"security-scan\"}",
    Collections.emptyList(),
    Map.of("build_number", 123)
);
memory.add("security-scan", List.of(logMessage));

// Retrieve conversation history
List&lt;Message&gt; history = memory.get("security-scan", 50);

// Check build completion
boolean buildComplete = memory.hasTwoBuildLogs("security-scan", 123);
</code></pre>
</div>
</div>
<dl class="notes">
<dt>Since:</dt>
<dd>1.0</dd>
<dt>Version:</dt>
<dd>1.0</dd>
<dt>Author:</dt>
<dd>Khasan Abdurakhmanov</dd>
<dt>See Also:</dt>
<dd>
<ul class="tag-list-long">
<li><code>ChatMemory</code></li>
<li><a href="../entity/ChatMessageEntity.html" title="class in com.diploma.inno.entity"><code>ChatMessageEntity</code></a></li>
<li><a href="../repository/ChatMessageRepository.html" title="interface in com.diploma.inno.repository"><code>ChatMessageRepository</code></a></li>
<li><a href="LogMessageListener.html" title="class in com.diploma.inno.component"><code>LogMessageListener</code></a></li>
<li><a href="CustomMetadataChatMemoryAdvisor.html" title="class in com.diploma.inno.component"><code>CustomMetadataChatMemoryAdvisor</code></a></li>
</ul>
</dd>
</dl>
</section>
<section class="summary">
<ul class="summary-list">
<!-- ======== CONSTRUCTOR SUMMARY ======== -->
<li>
<section class="constructor-summary" id="constructor-summary">
<h2>Constructor Summary</h2>
<div class="caption"><span>Constructors</span></div>
<div class="summary-table two-column-summary">
<div class="table-header col-first">Constructor</div>
<div class="table-header col-last">Description</div>
<div class="col-constructor-name even-row-color"><code><a href="#%3Cinit%3E(com.diploma.inno.repository.ChatMessageRepository,int)" class="member-name-link">SimpleDbChatMemory</a><wbr>(<a href="../repository/ChatMessageRepository.html" title="interface in com.diploma.inno.repository">ChatMessageRepository</a>&nbsp;repository,
 int&nbsp;maxMessagesPerConversation)</code></div>
<div class="col-last even-row-color">
<div class="block">Constructs a new SimpleDbChatMemory with specified repository and message limits.</div>
</div>
</div>
</section>
</li>
<!-- ========== METHOD SUMMARY =========== -->
<li>
<section class="method-summary" id="method-summary">
<h2>Method Summary</h2>
<div id="method-summary-table">
<div class="table-tabs" role="tablist" aria-orientation="horizontal"><button id="method-summary-table-tab0" role="tab" aria-selected="true" aria-controls="method-summary-table.tabpanel" tabindex="0" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table', 3)" class="active-table-tab">All Methods</button><button id="method-summary-table-tab2" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab2', 3)" class="table-tab">Instance Methods</button><button id="method-summary-table-tab4" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab4', 3)" class="table-tab">Concrete Methods</button></div>
<div id="method-summary-table.tabpanel" role="tabpanel">
<div class="summary-table three-column-summary" aria-labelledby="method-summary-table-tab0">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Method</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#add(java.lang.String,java.util.List)" class="member-name-link">add</a><wbr>(<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;conversationId,
 <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/List.html" title="class or interface in java.util" class="external-link">List</a>&lt;org.springframework.ai.chat.messages.Message&gt;&nbsp;messages)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Adds messages to the conversation history with comprehensive validation &amp; metadata processing.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>void</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#clear(java.lang.String)" class="member-name-link">clear</a><wbr>(<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;conversationId)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Clears all messages from a specific conversation with complete data removal.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/List.html" title="class or interface in java.util" class="external-link">List</a><wbr>&lt;org.springframework.ai.chat.messages.Message&gt;</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#get(java.lang.String,int)" class="member-name-link">get</a><wbr>(<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;conversationId,
 int&nbsp;lastN)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Retrieves the most recent messages from a conversation with optimized database queries.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>boolean</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#hasTwoBuildLogs(java.lang.String,int)" class="member-name-link">hasTwoBuildLogs</a><wbr>(<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;conversationId,
 int&nbsp;buildNumber)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Checks if a specific Jenkins build has completed its build log sequence for AI trigger readiness.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#pruneOldMessages()" class="member-name-link">pruneOldMessages</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Performs scheduled cleanup of old messages to maintain optimal database performance &amp; storage efficiency.</div>
</div>
</div>
</div>
</div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-java.lang.Object">Methods inherited from class&nbsp;java.lang.<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a></h3>
<code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#clone()" title="class or interface in java.lang" class="external-link">clone</a>, <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#equals(java.lang.Object)" title="class or interface in java.lang" class="external-link">equals</a>, <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#finalize()" title="class or interface in java.lang" class="external-link">finalize</a>, <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#getClass()" title="class or interface in java.lang" class="external-link">getClass</a>, <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#hashCode()" title="class or interface in java.lang" class="external-link">hashCode</a>, <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#notify()" title="class or interface in java.lang" class="external-link">notify</a>, <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#notifyAll()" title="class or interface in java.lang" class="external-link">notifyAll</a>, <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#toString()" title="class or interface in java.lang" class="external-link">toString</a>, <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#wait()" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#wait(long)" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#wait(long,int)" title="class or interface in java.lang" class="external-link">wait</a></code></div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-org.springframework.ai.chat.memory.ChatMemory">Methods inherited from interface&nbsp;org.springframework.ai.chat.memory.ChatMemory</h3>
<code>add</code></div>
</section>
</li>
</ul>
</section>
<section class="details">
<ul class="details-list">
<!-- ========= CONSTRUCTOR DETAIL ======== -->
<li>
<section class="constructor-details" id="constructor-detail">
<h2>Constructor Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="&lt;init&gt;(com.diploma.inno.repository.ChatMessageRepository,int)">
<h3>SimpleDbChatMemory</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="element-name">SimpleDbChatMemory</span><wbr><span class="parameters">(<a href="../repository/ChatMessageRepository.html" title="interface in com.diploma.inno.repository">ChatMessageRepository</a>&nbsp;repository,
 int&nbsp;maxMessagesPerConversation)</span></div>
<div class="block">Constructs a new SimpleDbChatMemory with specified repository and message limits.

 <p>This constructor initializes the chat memory implementation with database persistence
 and configurable memory management. The implementation is designed for high-volume
 Jenkins log processing with automatic cleanup and optimization.</p>

 <h4 id="configuration-guidelines--heading">Configuration Guidelines:</h4>
 <ul>
   <li><strong>Small Conversations (1-50 messages):</strong> Suitable for individual build analysis</li>
   <li><strong>Medium Conversations (50-200 messages):</strong> Ideal for job-level monitoring</li>
   <li><strong>Large Conversations (200+ messages):</strong> For comprehensive historical analysis</li>
 </ul>

 <h4 id="memory-management-impact--heading">Memory Management Impact:</h4>
 <p>The maxMessagesPerConversation parameter directly affects:</p>
 <ul>
   <li><strong>Database Storage:</strong> Controls growth rate of chat_messages table</li>
   <li><strong>Query Performance:</strong> Larger windows may impact retrieval speed</li>
   <li><strong>AI Context:</strong> More messages provide richer context but increase token usage</li>
   <li><strong>Memory Usage:</strong> Affects in-memory processing during retrieval</li>
 </ul>

 <h4 id="repository-requirements--heading">Repository Requirements:</h4>
 <p>The provided repository must support:</p>
 <ul>
   <li>CRUD operations on <a href="../entity/ChatMessageEntity.html" title="class in com.diploma.inno.entity"><code>ChatMessageEntity</code></a></li>
   <li>Custom queries for conversation management</li>
   <li>Efficient pagination and ordering</li>
   <li>Bulk delete operations for cleanup</li>
 </ul></div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>repository</code> - the chat message repository for database operations.
                   Must not be <code>null</code> and should be properly configured
                   with database connection and transaction management.</dd>
<dd><code>maxMessagesPerConversation</code> - the maximum number of messages to retain per conversation.
                                   Must be positive. Recommended range: 50-200 for optimal performance.</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/NullPointerException.html" title="class or interface in java.lang" class="external-link">NullPointerException</a></code> - if repository is <code>null</code></dd>
<dd><code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/IllegalArgumentException.html" title="class or interface in java.lang" class="external-link">IllegalArgumentException</a></code> - if maxMessagesPerConversation is not positive</dd>
<dt>See Also:</dt>
<dd>
<ul class="tag-list">
<li><a href="../repository/ChatMessageRepository.html" title="interface in com.diploma.inno.repository"><code>ChatMessageRepository</code></a></li>
<li><a href="../entity/ChatMessageEntity.html" title="class in com.diploma.inno.entity"><code>ChatMessageEntity</code></a></li>
</ul>
</dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
<!-- ============ METHOD DETAIL ========== -->
<li>
<section class="method-details" id="method-detail">
<h2>Method Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="pruneOldMessages()">
<h3>pruneOldMessages</h3>
<div class="member-signature"><span class="annotations">@Scheduled(fixedRate=3600000L,
           initialDelay=3600000L)
@Transactional
</span><span class="modifiers">public</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">pruneOldMessages</span>()</div>
<div class="block">Performs scheduled cleanup of old messages to maintain optimal database performance &amp; storage efficiency.

 <p>This method implements an automated maintenance strategy that prevents unbounded growth
 of conversation history while preserving recent context for AI analysis. It runs on a
 fixed schedule to ensure consistent performance characteristics over time.</p>

 <h4 id="cleanup-strategy--heading">Cleanup Strategy:</h4>
 <p>The pruning process follows a sophisticated sliding window approach:</p>
 <ol>
   <li><strong>Discovery:</strong> Identifies all active conversation IDs in the database</li>
   <li><strong>Analysis:</strong> Determines message count per conversation</li>
   <li><strong>Pruning:</strong> Removes oldest messages beyond the configured limit</li>
   <li><strong>Preservation:</strong> Maintains most recent messages for each conversation</li>
 </ol>

 <h4 id="scheduling-configuration--heading">Scheduling Configuration:</h4>
 <ul>
   <li><strong>Frequency:</strong> Every 3,600,000ms (1 hour)</li>
   <li><strong>Initial Delay:</strong> 3,600,000ms (1 hour after startup)</li>
   <li><strong>Execution:</strong> Single-threaded to prevent concurrent cleanup conflicts</li>
 </ul>

 <h4 id="performance-impact--heading">Performance Impact:</h4>
 <p>The cleanup operation is designed for minimal system impact:</p>
 <ul>
   <li><strong>Database Load:</strong> Uses efficient bulk delete operations</li>
   <li><strong>Transaction Scope:</strong> Atomic operations prevent data inconsistency</li>
   <li><strong>Timing:</strong> Scheduled during typical low-activity periods</li>
   <li><strong>Monitoring:</strong> Comprehensive logging for operational visibility</li>
 </ul>

 <h4 id="cleanup-metrics--heading">Cleanup Metrics:</h4>
 <p>The method provides operational insights through logging:</p>
 
<div class="snippet-container"><button class="copy snippet-copy" aria-label="Copy snippet" onclick="copySnippet(this)"><span data-copied="Copied!">Copy</span><img src="../../../../copy.svg" alt="Copy snippet"></button>
<pre class="snippet"><code class="language-java">// Example log output during cleanup
INFO  - Running pruneOldMessages Scheduled
DEBUG - Processing conversation: jenkins-security-scan (245 messages)
DEBUG - Deleted 45 old messages, retained 200 recent messages
INFO  - Successfully deleted!
</code></pre>
</div>


 <h4 id="error-handling--heading">Error Handling:</h4>
 <p>The cleanup process includes robust error handling:</p>
 <ul>
   <li><strong>Transaction Rollback:</strong> Failed operations don't affect other conversations</li>
   <li><strong>Continuation:</strong> Errors in one conversation don't stop overall cleanup</li>
   <li><strong>Logging:</strong> Detailed error information for troubleshooting</li>
 </ul></div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="tag-list-long">
<li><code>Scheduled</code></li>
<li><code>Transactional</code></li>
<li><a href="../repository/ChatMessageRepository.html#findAllConversationIds()"><code>ChatMessageRepository.findAllConversationIds()</code></a></li>
<li><a href="../repository/ChatMessageRepository.html#deleteOldMessages(java.lang.String,int)"><code>ChatMessageRepository.deleteOldMessages(String, int)</code></a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="add(java.lang.String,java.util.List)">
<h3>add</h3>
<div class="member-signature"><span class="annotations">@Transactional
</span><span class="modifiers">public</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">add</span><wbr><span class="parameters">(<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;conversationId,
 <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/List.html" title="class or interface in java.util" class="external-link">List</a>&lt;org.springframework.ai.chat.messages.Message&gt;&nbsp;messages)</span></div>
<div class="block">Adds messages to the conversation history with comprehensive validation &amp; metadata processing.

 <p>This method implements the core message storage functionality, handling Jenkins log messages
 with sophisticated content processing, metadata extraction, and build number correlation.
 It ensures data integrity while optimizing for high-volume log ingestion.</p>

 <h4 id="message-processing-pipeline--heading">Message Processing Pipeline:</h4>
 <ol>
   <li><strong>Input Validation:</strong> Validates conversation ID &amp; message list</li>
   <li><strong>Content Processing:</strong> Extracts &amp; validates message content</li>
   <li><strong>Size Management:</strong> Applies truncation for oversized messages</li>
   <li><strong>Metadata Extraction:</strong> Processes build numbers &amp; contextual data</li>
   <li><strong>Entity Creation:</strong> Converts to database entities</li>
   <li><strong>Persistence:</strong> Stores in database with transaction safety</li>
 </ol>

 <h4 id="content-size-management--heading">Content Size Management:</h4>
 <p>The method implements intelligent content truncation:</p>
 <ul>
   <li><strong>Size Limit:</strong> 10000000 characters (≈10MB)</li>
   <li><strong>Truncation Strategy:</strong> Preserves beginning of content for context</li>
   <li><strong>Warning Logging:</strong> Alerts when truncation occurs</li>
   <li><strong>Graceful Handling:</strong> Continues processing despite size issues</li>
 </ul>

 <h4 id="build-number-extraction--heading">Build Number Extraction:</h4>
 <p>Sophisticated metadata processing for Jenkins integration:</p>
 
<div class="snippet-container"><button class="copy snippet-copy" aria-label="Copy snippet" onclick="copySnippet(this)"><span data-copied="Copied!">Copy</span><img src="../../../../copy.svg" alt="Copy snippet"></button>
<pre class="snippet"><code class="language-java">// Supported build number formats
Map&lt;String, Object&gt; metadata = Map.of(
    "build_number", 123,           // Integer
    "build_number", "456",         // String (parsed)
    "build_number", 789L           // Long (converted)
);

// Fallback behavior
Map&lt;String, Object&gt; metadata = Map.of(
    "other_field", "value"         // Missing build_number → defaults to 0
);
</code></pre>
</div>


 <h4 id="message-type-support--heading">Message Type Support:</h4>
 <p>Handles all Spring AI message types:</p>
 <ul>
   <li><strong>USER:</strong> Jenkins log messages, build data, scan results</li>
   <li><strong>ASSISTANT:</strong> AI analysis responses, anomaly reports</li>
   <li><strong>SYSTEM:</strong> System messages (logged but not stored)</li>
 </ul>

 <h4 id="transaction-behavior--heading">Transaction Behavior:</h4>
 <p>The method operates within a transaction boundary:</p>
 <ul>
   <li><strong>Atomicity:</strong> All messages in the list are stored atomically</li>
   <li><strong>Rollback:</strong> Failures cause complete rollback of the batch</li>
   <li><strong>Isolation:</strong> Concurrent operations don't interfere</li>
   <li><strong>Durability:</strong> Committed messages are permanently stored</li>
 </ul>

 <h4 id="error-handling--heading1">Error Handling:</h4>
 <p>Comprehensive error handling ensures system resilience:</p>
 <ul>
   <li><strong>Null Content:</strong> Skips messages with null content</li>
   <li><strong>Invalid Build Numbers:</strong> Uses default value (0)</li>
   <li><strong>Database Errors:</strong> Propagated for proper error handling</li>
 </ul></div>
<dl class="notes">
<dt>Specified by:</dt>
<dd><code>add</code>&nbsp;in interface&nbsp;<code>org.springframework.ai.chat.memory.ChatMemory</code></dd>
<dt>Parameters:</dt>
<dd><code>conversationId</code> - the conversation identifier, typically a Jenkins job name.
                       Must not be <code>null</code>. Used for message grouping and retrieval.</dd>
<dd><code>messages</code> - the list of messages to add to the conversation.
                 Can be empty (no-op) but not <code>null</code>. Each message is processed individually.</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/NullPointerException.html" title="class or interface in java.lang" class="external-link">NullPointerException</a></code> - if conversationId is <code>null</code></dd>
<dd><code>org.springframework.dao.DataAccessException</code> - if database operation fails</dd>
<dt>See Also:</dt>
<dd>
<ul class="tag-list-long">
<li><code>Message</code></li>
<li><a href="../entity/ChatMessageEntity.html" title="class in com.diploma.inno.entity"><code>ChatMessageEntity</code></a></li>
<li><a href="#get(java.lang.String,int)"><code>get(String, int)</code></a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="get(java.lang.String,int)">
<h3>get</h3>
<div class="member-signature"><span class="annotations">@Transactional(readOnly=true)
</span><span class="modifiers">public</span>&nbsp;<span class="return-type"><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/List.html" title="class or interface in java.util" class="external-link">List</a>&lt;org.springframework.ai.chat.messages.Message&gt;</span>&nbsp;<span class="element-name">get</span><wbr><span class="parameters">(<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;conversationId,
 int&nbsp;lastN)</span></div>
<div class="block">Retrieves the most recent messages from a conversation with optimized database queries.

 <p>This method implements efficient conversation history retrieval using database-level
 pagination and ordering. It's specifically optimized for AI context preparation where
 recent conversation history is needed for anomaly detection analysis.</p>

 <h4 id="retrieval-strategy--heading">Retrieval Strategy:</h4>
 <p>The method uses a sophisticated query approach:</p>
 <ol>
   <li><strong>Database Query:</strong> Leverages repository's optimized query with LIMIT</li>
   <li><strong>Ordering:</strong> Returns messages in chronological order (oldest first)</li>
   <li><strong>Conversion:</strong> Transforms entities to Spring AI Message objects</li>
   <li><strong>Filtering:</strong> Removes any malformed or unconvertible messages</li>
 </ol>

 <h4 id="performance-characteristics--heading">Performance Characteristics:</h4>
 <ul>
   <li><strong>Query Efficiency:</strong> Uses indexed queries with LIMIT for optimal performance</li>
   <li><strong>Memory Usage:</strong> Bounded by lastN parameter, preventing memory exhaustion</li>
   <li><strong>Conversion Speed:</strong> Efficient entity-to-message transformation</li>
   <li><strong>Caching:</strong> Repository-level caching for frequently accessed conversations</li>
 </ul>

 <h4 id="message-ordering--heading">Message Ordering:</h4>
 <p>Messages are returned in chronological order to maintain conversation flow:</p>
 
<div class="snippet-container"><button class="copy snippet-copy" aria-label="Copy snippet" onclick="copySnippet(this)"><span data-copied="Copied!">Copy</span><img src="../../../../copy.svg" alt="Copy snippet"></button>
<pre class="snippet"><code class="language-java">// Example conversation flow
List&lt;Message&gt; messages = memory.get("jenkins-security", 5);
// Returns: [oldest_message, ..., newest_message]

// Typical Jenkins log sequence
// 1. UserMessage: build_log_data (initial)
// 2. UserMessage: secret_detection
// 3. UserMessage: dependency_data
// 4. UserMessage: build_log_data (final)
// 5. AssistantMessage: AI analysis result
</code></pre>
</div>


 <h4 id="error-handling-resilience--heading">Error Handling &amp; Resilience:</h4>
 <p>The method includes comprehensive error handling:</p>
 <ul>
   <li><strong>Null Filtering:</strong> Removes messages that fail conversion</li>
   <li><strong>Empty Results:</strong> Gracefully handles conversations with no messages</li>
   <li><strong>Database Errors:</strong> Propagates exceptions for proper error handling</li>
   <li><strong>Validation:</strong> Ensures all returned messages are valid</li>
 </ul>

 <h4 id="use-cases--heading">Use Cases:</h4>
 <ul>
   <li><strong>AI Context Preparation:</strong> Retrieving recent history for anomaly analysis</li>
   <li><strong>Build Monitoring:</strong> Getting latest logs for specific Jenkins jobs</li>
   <li><strong>Debugging:</strong> Examining conversation flow for troubleshooting</li>
   <li><strong>Reporting:</strong> Generating summaries of recent activity</li>
 </ul></div>
<dl class="notes">
<dt>Specified by:</dt>
<dd><code>get</code>&nbsp;in interface&nbsp;<code>org.springframework.ai.chat.memory.ChatMemory</code></dd>
<dt>Parameters:</dt>
<dd><code>conversationId</code> - the conversation identifier to retrieve messages from.
                       Must not be <code>null</code>. Typically a Jenkins job name.</dd>
<dd><code>lastN</code> - the maximum number of recent messages to retrieve.
              Must be positive. Larger values may impact performance.</dd>
<dt>Returns:</dt>
<dd>a list of messages in chronological order (oldest first).
         Returns empty list if no messages exist or lastN ≤ 0.
         All returned messages are guaranteed to be valid and non-null.</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/NullPointerException.html" title="class or interface in java.lang" class="external-link">NullPointerException</a></code> - if conversationId is <code>null</code></dd>
<dd><code>org.springframework.dao.DataAccessException</code> - if database query fails</dd>
<dt>See Also:</dt>
<dd>
<ul class="tag-list-long">
<li><code>toMessage(ChatMessageEntity)</code></li>
<li><a href="../repository/ChatMessageRepository.html#findTopByConversationIdOrderByTimestampAsc(java.lang.String,int)"><code>ChatMessageRepository.findTopByConversationIdOrderByTimestampAsc(String, int)</code></a></li>
<li><code>Message</code></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="clear(java.lang.String)">
<h3>clear</h3>
<div class="member-signature"><span class="annotations">@Transactional
</span><span class="modifiers">public</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">clear</span><wbr><span class="parameters">(<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;conversationId)</span></div>
<div class="block">Clears all messages from a specific conversation with complete data removal.

 <p>This method provides a complete conversation reset capability, removing all
 historical messages while maintaining database integrity. It's particularly useful
 for testing, debugging, or when conversation context needs to be completely reset.</p>

 <h4 id="deletion-strategy--heading">Deletion Strategy:</h4>
 <p>The method implements a comprehensive deletion approach:</p>
 <ol>
   <li><strong>Validation:</strong> Ensures conversation ID is valid</li>
   <li><strong>Bulk Deletion:</strong> Removes all messages in a single transaction</li>
   <li><strong>Logging:</strong> Records the deletion operation for audit purposes</li>
   <li><strong>Integrity:</strong> Maintains referential integrity during deletion</li>
 </ol>

 <h4 id="transaction-behavior--heading1">Transaction Behavior:</h4>
 <ul>
   <li><strong>Atomicity:</strong> All messages are deleted atomically</li>
   <li><strong>Rollback:</strong> Failures result in no messages being deleted</li>
   <li><strong>Isolation:</strong> Concurrent operations don't interfere</li>
   <li><strong>Consistency:</strong> Database remains in consistent state</li>
 </ul>

 <h4 id="use-cases--heading1">Use Cases:</h4>
 <ul>
   <li><strong>Testing:</strong> Cleaning up test data between test runs</li>
   <li><strong>Debugging:</strong> Resetting conversation state for troubleshooting</li>
   <li><strong>Maintenance:</strong> Manual cleanup of problematic conversations</li>
   <li><strong>Privacy:</strong> Complete data removal when required</li>
 </ul>

 <h4 id="performance-impact--heading1">Performance Impact:</h4>
 <p>The deletion operation is optimized for efficiency:</p>
 <ul>
   <li><strong>Bulk Operation:</strong> Single query removes all matching records</li>
   <li><strong>Index Usage:</strong> Leverages conversation_id index for fast lookup</li>
   <li><strong>Minimal Locking:</strong> Short-duration locks minimize contention</li>
 </ul>

 <h4 id="warning--heading">Warning:</h4>
 <p><strong>This operation is irreversible.</strong> All conversation history
 will be permanently deleted. Ensure this is the intended behavior before calling.</p></div>
<dl class="notes">
<dt>Specified by:</dt>
<dd><code>clear</code>&nbsp;in interface&nbsp;<code>org.springframework.ai.chat.memory.ChatMemory</code></dd>
<dt>Parameters:</dt>
<dd><code>conversationId</code> - the conversation identifier for which to clear all messages.
                       Must not be <code>null</code>. Typically a Jenkins job name.</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/NullPointerException.html" title="class or interface in java.lang" class="external-link">NullPointerException</a></code> - if conversationId is <code>null</code></dd>
<dd><code>org.springframework.dao.DataAccessException</code> - if database deletion fails</dd>
<dt>See Also:</dt>
<dd>
<ul class="tag-list-long">
<li><a href="../repository/ChatMessageRepository.html#deleteByConversationId(java.lang.String)"><code>ChatMessageRepository.deleteByConversationId(String)</code></a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="hasTwoBuildLogs(java.lang.String,int)">
<h3>hasTwoBuildLogs</h3>
<div class="member-signature"><span class="annotations">@Transactional(readOnly=true)
</span><span class="modifiers">public</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name">hasTwoBuildLogs</span><wbr><span class="parameters">(<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;conversationId,
 int&nbsp;buildNumber)</span></div>
<div class="block">Checks if a specific Jenkins build has completed its build log sequence for AI trigger readiness.

 <p>This method implements a critical component of the Jenkins build monitoring system,
 determining when a build has produced both initial and final build logs required for
 comprehensive AI anomaly analysis. It's essential for the AI trigger mechanism.</p>

 <h4 id="build-log-sequence--heading">Build Log Sequence:</h4>
 <p>Jenkins builds produce exactly 2 <code>build_log_data</code> messages:</p>
 <ol>
   <li><strong>Initial Build Log:</strong> Produced at build start with setup information</li>
   <li><strong>Final Build Log:</strong> Generated at build completion with results</li>
 </ol>

 <h4 id="ai-trigger-logic--heading">AI Trigger Logic:</h4>
 <p>The method supports the sophisticated AI triggering strategy:</p>
 <ul>
   <li><strong>Prerequisite Check:</strong> Ensures both build logs are present</li>
   <li><strong>Completion Signal:</strong> Indicates build is ready for AI analysis</li>
   <li><strong>Context Validation:</strong> Confirms sufficient data for anomaly detection</li>
 </ul>

 <h4 id="query-strategy--heading">Query Strategy:</h4>
 <p>The method uses an optimized database query approach:</p>
 
<div class="snippet-container"><button class="copy snippet-copy" aria-label="Copy snippet" onclick="copySnippet(this)"><span data-copied="Copied!">Copy</span><img src="../../../../copy.svg" alt="Copy snippet"></button>
<pre class="snippet"><code class="language-java">// Efficient count query with multiple conditions
SELECT COUNT(*) FROM chat_messages
WHERE conversation_id = ?
  AND build_number = ?
  AND content LIKE '%build_log_data%'

// Expected result for complete builds: count = 2
</code></pre>
</div>


 <h4 id="performance-characteristics--heading1">Performance Characteristics:</h4>
 <ul>
   <li><strong>Query Efficiency:</strong> Uses indexed columns for fast lookup</li>
   <li><strong>Memory Usage:</strong> Returns only count, not full message content</li>
   <li><strong>Transaction Safety:</strong> Read-only transaction for consistency</li>
 </ul>

 <h4 id="use-cases--heading2">Use Cases:</h4>
 <ul>
   <li><strong>AI Triggering:</strong> Determining when to start anomaly analysis</li>
   <li><strong>Build Monitoring:</strong> Tracking build completion status</li>
   <li><strong>Quality Assurance:</strong> Ensuring complete log sequences</li>
   <li><strong>Debugging:</strong> Diagnosing incomplete build log issues</li>
 </ul>

 <h4 id="integration-with-logmessagelistener--heading">Integration with LogMessageListener:</h4>
 <p>This method is typically called by <a href="LogMessageListener.html" title="class in com.diploma.inno.component"><code>LogMessageListener</code></a> to determine
 AI trigger readiness:</p>
 
<div class="snippet-container"><button class="copy snippet-copy" aria-label="Copy snippet" onclick="copySnippet(this)"><span data-copied="Copied!">Copy</span><img src="../../../../copy.svg" alt="Copy snippet"></button>
<pre class="snippet"><code class="language-java">// Example usage in LogMessageListener
if (memory.hasTwoBuildLogs(conversationId, buildNumber)) {
    // Trigger AI analysis - build is complete
    String analysis = generateBuildSummary(conversationId, buildNumber);
    logger.info("AI analysis completed for build {}", buildNumber);
}
</code></pre>
</div>
</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>conversationId</code> - the Jenkins job name to check for build log completion.
                       Must not be <code>null</code>. Typically matches Jenkins job name.</dd>
<dd><code>buildNumber</code> - the specific build number to check for log completion.
                    Must be non-negative. Corresponds to Jenkins build number.</dd>
<dt>Returns:</dt>
<dd><code>true</code> if exactly 2 build_log_data messages exist for the specified
         conversation and build number, <code>false</code> otherwise.</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/NullPointerException.html" title="class or interface in java.lang" class="external-link">NullPointerException</a></code> - if conversationId is <code>null</code></dd>
<dd><code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/IllegalArgumentException.html" title="class or interface in java.lang" class="external-link">IllegalArgumentException</a></code> - if buildNumber is negative</dd>
<dd><code>org.springframework.dao.DataAccessException</code> - if database query fails</dd>
<dt>See Also:</dt>
<dd>
<ul class="tag-list-long">
<li><a href="LogMessageListener.html#processLogMessage(java.lang.String)"><code>LogMessageListener.processLogMessage(String)</code></a></li>
<li><a href="../repository/ChatMessageRepository.html#countByConversationIdAndBuildNumberAndContentContaining(java.lang.String,int)"><code>ChatMessageRepository.countByConversationIdAndBuildNumberAndContentContaining(String, int)</code></a></li>
</ul>
</dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
</ul>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
</div>
</div>
</body>
</html>
