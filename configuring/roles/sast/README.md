# SAST Ansible Role

This Ansible role deploys a **SAST (Static Application Security Testing) Platform** with Docker Engine configured for TLS security, providing a secure environment for running comprehensive static analysis security tools. It serves as the secure container runtime foundation for the DevSecOps platform's security analysis capabilities.

## 🎯 **Overview**

The `sast` role is a critical security component of the DevSecOps platform that:

- **Secure Docker Runtime**: Deploys Docker Engine with TLS encryption for secure remote access
- **Certificate Integration**: Seamlessly integrates with FirstStage-generated TLS certificates
- **SAST Tools Platform**: Provides pre-configured environment for multiple security analysis tools
- **Remote API Access**: Enables secure Docker API access for FirstStage secret detection integration
- **Production Security**: Implements security best practices with hardened Docker daemon configuration
- **Multi-Tool Support**: Ready-to-use environment for Semgrep, Bearer, Trivy, Horusec, and custom tools

## 🏗️ **Architecture & Integration**

### **Role in DevSecOps Pipeline**
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   LiftOffStage  │    │ FirstStage-Prep │    │   FirstStage    │    │      SAST       │
│ (External Svcs) │ -> │ (Certificates)  │ -> │ (Secret Scan)   │ -> │ (Secure Docker) │
│                 │    │                 │    │                 │    │                 │
│ • Jenkins       │    │ • TLS Certs     │    │ • Spring Boot   │    │ • Docker Engine │
│ • RabbitMQ      │    │ • VPN Setup     │    │ • PostgreSQL    │    │ • SAST Tools    │
│ • PostgreSQL CI │    │ • File Prep     │    │ • Docker API    │    │ • TLS Security  │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
```

### **SAST Platform Architecture**
```
┌─────────────────────────────────────────────────────────────┐
│                      SAST Platform                         │
├─────────────────────────────┬───────────────────────────────┤
│      Docker Engine          │       SAST Tools Suite       │
│      (TLS Secured)          │                               │
├─────────────────────────────┼───────────────────────────────┤
│ • TLS Port: 2376            │ • Semgrep Pro                 │
│ • Certificate Auth          │ • Bearer Security Scanner     │
│ • Remote API Access         │ • Trivy Vulnerability Scanner │
│ • Secure Communication      │ • Horusec Multi-Language SAST │
│ • FirstStage Integration    │ • Alpine Git Tools            │
└─────────────────────────────┴───────────────────────────────┘
```

## 📋 **Prerequisites**

### **Infrastructure Requirements**
- **Target Node**: Ubuntu 20.04+ with sufficient resources for Docker and SAST tools
- **Network**: Secure network connectivity between FirstStage and SAST nodes
- **Storage**: Minimum 20GB free space for Docker images and analysis workspaces
- **Memory**: Minimum 4GB RAM for SAST tool execution

### **Dependencies**
- **FirstStage-Prep Role**: Must be executed first to generate TLS certificates
- **Certificate Availability**: Server certificates must be available on Ansible control node
- **Docker Requirements**: System must support Docker Engine installation
- **Network Access**: Internet connectivity for Docker image pulling

### **Certificate Integration**
The role expects certificates to be available on the Ansible control node at:

```bash
{{ playbook_dir }}/server_certificates/
├── ca.pem              # Certificate Authority (generated by FirstStage-Prep)
├── server-cert.pem     # Server certificate (generated by FirstStage-Prep)
└── server-key.pem      # Server private key (generated by FirstStage-Prep)
```

**Certificate Flow:**
1. **FirstStage-Prep** generates TLS certificates
2. **FirstStage-Prep** downloads server certificates to control node
3. **SAST** role copies certificates to target SAST node
4. **SAST** role configures Docker daemon with TLS security

## ⚙️ **Configuration Variables**

All variables are defined in `defaults/main.yml` and `vars/main.yml`, and can be overridden via Ansible Vault, group_vars, or playbook variables.

### **🌐 Target Node Configuration**

| Variable | Default | Description |
|----------|---------|-------------|
| `sast_target_node` | `worker` | Target node for SAST platform deployment |

### **🔐 Docker TLS Configuration**

| Variable | Default | Description |
|----------|---------|-------------|
| `docker_tls_enabled` | `true` | Enable TLS encryption for Docker daemon |
| `docker_daemon_port` | `2376` | Docker daemon TLS port |
| `docker_certs_dir` | `/etc/docker/certs` | Certificate directory on target node |
| `docker_service_file` | `/lib/systemd/system/docker.service` | Docker systemd service file path |
| `docker_tls_flags` | `--tlsverify --tlscacert=... --tlscert=... --tlskey=... -H tcp://0.0.0.0:2376` | Docker TLS configuration flags |

### **📜 Certificate Configuration**

| Variable | Default | Description |
|----------|---------|-------------|
| `local_certs_dir` | `{{ playbook_dir }}/server_certificates/` | Certificate directory on Ansible control node |
| `cert_files.ca_cert` | `ca.pem` | Certificate Authority filename |
| `cert_files.server_cert` | `server-cert.pem` | Server certificate filename |
| `cert_files.server_key` | `server-key.pem` | Server private key filename |

### **🛠️ SAST Tools Configuration**

| Variable | Default | Description |
|----------|---------|-------------|
| `sast_tools` | 4 tools enabled | SAST tools configuration (Semgrep, Bearer, Trivy, Horusec) |
| `sast_images` | 8 container images | Pre-configured SAST tool container images |

#### **SAST Tools Included:**
```yaml
sast_tools:
  - name: "semgrep"     # Semgrep Pro static analysis
    enabled: true
  - name: "bearer"      # Bearer security scanner
    enabled: true
  - name: "trivy"       # Trivy vulnerability scanner
    enabled: true
  - name: "horusec"     # Horusec multi-language SAST
    enabled: true
```

#### **SAST Container Images:**
```yaml
sast_images:
  - "alpine/git:v2.47.2"                                           # Git tools
  - "semgrep/semgrep:pro-sha-2e03a2a6e75d2cb4bdf5275148b9397e3c79796a"  # Semgrep Pro
  - "horuszup/horusec-cli:v2.9.0-beta.3"                          # Horusec CLI
  - "bearer/bearer:1.49.0"                                        # Bearer scanner
  - "horuszup/horusec-generic:v1.2.0"                            # Horusec Generic
  - "horuszup/horusec-shell:v1.0.1"                              # Horusec Shell
  - "horuszup/horusec-js:v1.2.0"                                 # Horusec JavaScript
  - "aquasec/trivy:0.61.0"                                       # Trivy scanner
```

### **🐳 Docker Infrastructure** (vars/main.yml)

| Variable | Default | Description |
|----------|---------|-------------|
| `docker_packages` | `[docker-ce, docker-ce-cli, containerd.io, ...]` | Docker packages to install |
| `docker_dependencies` | `[apt-transport-https, ca-certificates, ...]` | System dependencies |
| `docker_repo_url` | `https://download.docker.com/linux/ubuntu` | Docker repository URL |
| `docker_gpg_key_url` | `https://download.docker.com/linux/ubuntu/gpg` | Docker GPG key URL |
| `docker_group` | `docker` | Docker group name |
| `docker_user` | `ubuntu` | User to add to Docker group |
| `cert_file_permissions` | `{ca_cert: "0644", server_cert: "0644", server_key: "0600"}` | Certificate file permissions |

## 🚀 **Deployment Process**

The SAST role executes a comprehensive 8-phase deployment process:

### **Phase 1: System Preparation**
```yaml
# System setup and package management
1. Sets hostname for target worker node
2. Updates APT package cache
3. Installs required system dependencies
4. Prepares system for Docker installation
```

### **Phase 2: Docker Repository Setup**
```yaml
# Docker official repository configuration
1. Adds Docker GPG key for package verification
2. Adds Docker official APT repository
3. Updates package cache with Docker packages
4. Prepares for Docker Engine installation
```

### **Phase 3: Docker Engine Installation**
```yaml
# Docker Engine and components installation
1. Installs Docker CE, CLI, and containerd
2. Installs Docker Buildx and Compose plugins
3. Starts and enables Docker service
4. Configures Docker daemon for system startup
```

### **Phase 4: User and Group Configuration**
```yaml
# Docker access and permissions setup
1. Creates Docker group for non-root access
2. Adds specified user to Docker group
3. Configures proper user permissions
4. Enables non-root Docker operations
```

### **Phase 5: Certificate Management**
```yaml
# TLS certificate deployment and validation
1. Creates Docker certificates directory
2. Validates certificate availability on control node
3. Copies CA certificate with proper permissions
4. Copies server certificate and private key
5. Sets secure file permissions (600 for private keys)
```

### **Phase 6: Docker TLS Configuration**
```yaml
# Docker daemon TLS security setup
1. Backs up original Docker service file
2. Reads current Docker service configuration
3. Updates ExecStart with TLS flags
4. Preserves existing Docker daemon flags
5. Configures TLS verification and certificate paths
```

### **Phase 7: Service Management & Verification**
```yaml
# Docker service restart and validation
1. Reloads systemd daemon configuration
2. Restarts Docker service with TLS configuration
3. Waits for Docker daemon to be ready on TLS port
4. Validates Docker API accessibility
5. Confirms TLS security is properly configured
```

### **Phase 8: SAST Tools Preparation**
```yaml
# SAST tool images and environment setup
1. Pulls all configured SAST tool container images
2. Verifies successful image downloads
3. Displays image pull results and status
4. Prepares environment for SAST analysis
5. Creates deployment summary with connection details
```

## 📖 **Usage Examples**

### **Basic Production Deployment**
```yaml
---
- name: Deploy SAST Platform with TLS Security
  hosts: master
  become: yes
  roles:
    - role: sast
  vars:
    # Core configuration
    sast_target_node: "sast-production"

    # Custom TLS port
    docker_daemon_port: 2376

    # Certificate location (matches FirstStage-Prep)
    local_certs_dir: "{{ playbook_dir }}/server_certificates/"
```

### **Development Environment**
```yaml
---
- name: Deploy SAST for Development
  hosts: master
  become: yes
  roles:
    - role: sast
  vars:
    # Development configuration
    sast_target_node: "dev-worker"

    # Custom certificate location
    local_certs_dir: "/tmp/dev-certificates/"

    # Custom Docker configuration
    docker_certs_dir: "/etc/docker/dev-certs"
```

### **High-Security Configuration**
```yaml
---
- name: Deploy SAST with Enhanced Security
  hosts: master
  become: yes
  roles:
    - role: sast
  vars:
    # Enhanced security configuration
    sast_target_node: "secure-sast-node"
    docker_daemon_port: 2377  # Non-standard port

    # Custom certificate directory
    docker_certs_dir: "/opt/docker/secure-certs"

    # Specific SAST tools only
    sast_tools:
      - name: "semgrep"
        enabled: true
      - name: "trivy"
        enabled: true
      - name: "bearer"
        enabled: false
      - name: "horusec"
        enabled: false
```

### **Ansible Vault Integration**
```yaml
---
- name: Deploy SAST with Encrypted Configuration
  hosts: master
  become: yes
  vars_files:
    - "{{ inventory_dir }}/vault/secrets.yml"
  roles:
    - role: sast
  vars:
    # Use vault-encrypted configurations
    sast_target_node: "{{ vault_sast_node }}"
    docker_daemon_port: "{{ vault_sast_docker_port }}"
    local_certs_dir: "{{ vault_sast_cert_dir }}"

    # Custom Docker user from vault
    docker_user: "{{ vault_sast_docker_user }}"
```

## 🔐 **TLS Security & Access**

### **Docker API Access**
After successful deployment, the SAST platform provides secure Docker API access:

```yaml
# TLS-Secured Docker API
Endpoint: https://<sast-node-ip>:2376
Protocol: Docker API over TLS
Authentication: Server-side TLS with certificate verification
Security: Encrypted communication with certificate-based trust
```

### **Connection Examples**

#### **From Ansible Control Node**
```bash
# Basic Docker API access
docker --tls \
       --tlscacert={{ playbook_dir }}/server_certificates/ca.pem \
       -H=<sast-node-ip>:2376 version

# List running containers
docker --tls \
       --tlscacert={{ playbook_dir }}/server_certificates/ca.pem \
       -H=<sast-node-ip>:2376 ps

# Run SAST analysis container
docker --tls \
       --tlscacert={{ playbook_dir }}/server_certificates/ca.pem \
       -H=<sast-node-ip>:2376 run --rm semgrep/semgrep:latest --help
```

#### **From FirstStage Application**
```java
// FirstStage Spring Boot application uses these certificates
// for secure Docker API communication during secret scanning
DockerClientConfig config = DefaultDockerClientConfig.createDefaultConfigBuilder()
    .withDockerHost("tcp://<sast-node-ip>:2376")
    .withDockerTlsVerify(true)
    .withDockerCertPath("/opt/firststage/app-files/src/main/resources/cert/")
    .build();
```

### **Certificate Verification**
```bash
# Verify certificate validity
openssl x509 -in {{ playbook_dir }}/server_certificates/server-cert.pem -text -noout

# Check certificate expiration
openssl x509 -in {{ playbook_dir }}/server_certificates/server-cert.pem -noout -dates

# Validate certificate chain
openssl verify -CAfile {{ playbook_dir }}/server_certificates/ca.pem \
               {{ playbook_dir }}/server_certificates/server-cert.pem
```

## 🔗 **Integration with DevSecOps Pipeline**

### **Role Dependencies**
```yaml
# Execution order in main playbook:
1. common                    # Basic system setup
2. containerd               # Container runtime (if needed)
3. kubernetes               # Kubernetes cluster (if needed)
4. worker                   # Worker node configuration
5. liftoffstage            # External services
6. firststage-prep         # Certificate generation and file preparation
7. firststage              # Secret detection application
8. sast                    # THIS ROLE - Secure Docker platform
9. secondstage             # AI analysis (uses SAST for container analysis)
10. thirdstage             # Dashboard frontend
```

### **Service Communication Flow**
```yaml
# SAST platform integrates with:
FirstStage Application:
  - Secure Docker API access for container analysis
  - TLS-encrypted communication using shared certificates
  - Remote container execution for security scanning

SecondStage (Optional):
  - Container-based AI analysis
  - Secure Docker API access for advanced scanning
  - Dynamic container deployment for specialized analysis

CI/CD Pipelines:
  - Automated security scanning integration
  - Container-based SAST tool execution
  - Secure API access for build pipeline integration
```

### **Security Analysis Workflow**
```yaml
# Complete security analysis pipeline:
Code Repository → FirstStage Secret Detection → SAST Platform Analysis
    ↓
Container Security Scanning → Vulnerability Assessment
    ↓
AI-Powered Analysis (SecondStage) → Risk Scoring
    ↓
Dashboard Visualization (ThirdStage) → Security Reports
```

## 🚨 **Troubleshooting Guide**

### **Common Issues & Solutions**

#### **🔴 Certificate Issues**
```bash
# Check certificate availability on control node
ls -la {{ playbook_dir }}/server_certificates/
ls -la {{ playbook_dir }}/server_certificates/*.pem

# Verify certificate permissions on target node
ls -la /etc/docker/certs/
stat /etc/docker/certs/server-key.pem

# Test certificate validity
openssl x509 -in /etc/docker/certs/server-cert.pem -text -noout
```

#### **🔴 Docker Service Issues**
```bash
# Check Docker service status
systemctl status docker
systemctl is-active docker

# View Docker service logs
journalctl -u docker --no-pager --lines=50

# Check Docker daemon configuration
cat /lib/systemd/system/docker.service | grep ExecStart

# Restart Docker service manually
sudo systemctl daemon-reload
sudo systemctl restart docker
```

#### **🔴 TLS Connection Issues**
```bash
# Test Docker API connectivity
docker --tls --tlscacert=/etc/docker/certs/ca.pem -H=localhost:2376 version

# Check if Docker is listening on TLS port
netstat -tlnp | grep 2376
ss -tlnp | grep 2376

# Test from remote host
telnet <sast-node-ip> 2376
```

#### **🔴 SAST Tool Issues**
```bash
# Check Docker images
docker images | grep -E "(semgrep|bearer|trivy|horusec)"

# Test SAST tool execution
docker run --rm semgrep/semgrep:latest --version
docker run --rm aquasec/trivy:latest --version

# Check Docker daemon logs
journalctl -u docker -f
```

### **🔧 Diagnostic Commands**
```bash
# Complete system status
systemctl status docker
docker --tls -H=localhost:2376 info

# Certificate validation
openssl verify -CAfile /etc/docker/certs/ca.pem /etc/docker/certs/server-cert.pem

# Network connectivity
netstat -tlnp | grep docker
ss -tlnp | grep 2376

# Service configuration
cat /lib/systemd/system/docker.service
systemctl show docker --property=ExecStart
```

### **🔄 Recovery Procedures**
```bash
# Reset Docker service configuration
sudo cp /lib/systemd/system/docker.service.backup /lib/systemd/system/docker.service
sudo systemctl daemon-reload
sudo systemctl restart docker

# Regenerate certificates (re-run FirstStage-Prep)
ansible-playbook -i inventory main.yml --tags firststage-prep

# Force Docker service restart
sudo systemctl stop docker
sudo systemctl start docker
sudo systemctl status docker
```

## 🔒 **Security Architecture**

### **TLS Security Features**
```yaml
# Comprehensive TLS security implementation:
Certificate-Based Authentication:
  - Server-side TLS verification
  - Certificate Authority validation
  - Encrypted communication channels

File Security:
  - CA certificate: 644 permissions (readable)
  - Server certificate: 644 permissions (readable)
  - Private key: 600 permissions (owner only)

Network Security:
  - TLS-only Docker API access
  - No unencrypted Docker socket exposure
  - Secure remote API communication
```

### **Docker Security Hardening**
```yaml
# Production security best practices:
Service Configuration:
  - TLS verification required
  - Certificate-based authentication
  - Secure systemd service configuration

Access Control:
  - Docker group membership required
  - Non-root user Docker access
  - Proper file permissions

Network Security:
  - TLS port 2376 (encrypted)
  - No plain HTTP Docker socket
  - Certificate validation required
```

## 📊 **Performance & Monitoring**

### **SAST Platform Metrics**
```bash
# Docker daemon performance
docker system df
docker system info

# Container resource usage
docker stats

# Image storage analysis
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
```

### **Security Tool Performance**
- **Semgrep**: Fast static analysis with rule-based detection
- **Bearer**: Comprehensive security and privacy scanning
- **Trivy**: Vulnerability scanning for containers and filesystems
- **Horusec**: Multi-language SAST with comprehensive coverage

## 📄 **License & Support**

### **License Information**
- **License**: MIT License
- **Author**: Khasan Abdurakhmanov
- **Organization**: Innopolis University DevSecOps Platform
- **Version**: 1.0.0
- **Last Updated**: 2025

### **Support Resources**
- **Documentation**: Comprehensive README with examples and troubleshooting
- **Community Support**: DevSecOps Platform community forums
- **Issue Tracking**: GitHub Issues for bug reports and feature requests
- **Professional Support**: Enterprise support available through Innopolis University

---

**🎉 Thank you for using the SAST Security Platform!**

This role provides enterprise-grade secure Docker runtime with comprehensive SAST tool support, TLS security, and seamless integration with the complete DevSecOps platform. For advanced configurations and enterprise support, please contact the DevSecOps Platform team.
